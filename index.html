<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Track Courier</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.1.1/css/bootstrap.min.css">
</head>
<body>
    <!-- Container where the different pages will be loaded -->
    <div class="container">
        <h1>Track Courier</h1>
        <hr/>
        <div class="home-page"></div>
        <div class="courier-details"></div>
        <div class="dashboard"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBahcCcZwj05QXi1AGOO1FlxRnfD05kaKU"></script>
    <!-- Home Page -->
    <script type="text/template" id="home-page">
        <% if (window.localStorage.getItem('userDetails') == null) { %>
            <a href="#login" class="btn btn-primary">Login</a>
            <a href="#signup" class="btn btn-primary">Signup</a>
        <% } else { %>
            <a href="#dashboard" class="btn btn-primary">Manage Couriers</a>
            <button class="btn btn-primary logout">Logout</button>
        <% } %>
        <br>

        <h3>Track Your Courier</h3>
        <form class="track-courier-form">
            <label>Courier Id</label>
            <input type="text" name="courier" class='courier-id'/>
            <br/>
            <button type="submit" class="btn btn-primary">Track</button>
        </form>
    </script>

    <script type="text/template" id="add-courier">
        Add courier here
        <a class="btn btn-primary back">Back</a>
    </script>

    <script type="text/template" id="update-courier">
        Update courier here
        <a class="btn btn-primary back">Back</a>
    </script>

    <script type="text/template" id="dashboard-page">
        <h2>Welcome to your dashboard </h2>
        <button class="btn btn-primary add-courier">Add Courier</button>
        <button class="btn btn-primary update-courier">Update Courier</button>
        <button class="btn btn-primary logout">Logout</button>
    </script>

    <!-- Login Page -->
    <script type="text/template" id="login-page">
        <h3>Login Page</h3>
        <form class="login-form">
            <label>Username</label>
            <input type="text" name="username" /><span class="username" style="color: red"/>

            <label>Password</label>
            <input type="password" name="password" /><span class="password" style="color: red"/>
            <br/>

            <button type="submit" class="btn btn-primary">Login</button>
            <a href="" class="btn btn-primary">Back</a>
        </form>
    </script>

    <!-- Signup Page -->
    <script type="text/template" id="signup-page">
        <h3>Signup Page</h3>
        <a href="" class="btn btn-primary">Back</a>
    </script>

    <!-- Courier Details -->
    <script type="text/template" id="courier-details">
        <h3>Courier Details</h3><hr/>
        <table class="table table-bordered">
          <tbody>
              <tr>
                  <th>Parcel ID</th>
                  <td><%= htmlEncode(parcel.get('parcel_id')) %></td>
              </tr>
              <tr>
                  <th>From Person</th>
                  <td><%= htmlEncode(parcel.get('from_person_name')) %></td>
              </tr>
              <tr>
                  <th>To Person</th>
                  <td><%= htmlEncode(parcel.get('to_person_name')) %></td>
              </tr>
              <tr>
                  <th>Color</th>
                  <td><%= htmlEncode(parcel.get('color')) %></td>
              </tr>
              <tr>
                  <th>Weight</th>
                  <td><%= htmlEncode(parcel.get('weight')) %></td>
              </tr>
              <tr>
                  <th>Dispatched On</th>
                  <td><%= htmlEncode(parcel.get('dispatched_on')) %></td>
              </tr>
              <tr>
                  <th>Expected Delivery</th>
                  <td><%= htmlEncode(parcel.get('expected_delivery')) %></td>
              </tr>
              <tr>
                  <th>Sender Address</th>
                  <td><%= htmlEncode(parcel.get('sender_address')) %></td>
              </tr>
              <tr>
                  <th>Receiver Address</th>
                  <td><%= htmlEncode(parcel.get('receiver_address')) %></td>
              </tr>
              <tr>
                  <th>Sender Phone No</th>
                  <td><%= htmlEncode(parcel.get('sender_phone_no')) %></td>
              </tr>
              <tr>
                  <th>Receiver Phone No</th>
                  <td><%= htmlEncode(parcel.get('receiver_phone_no')) %></td>
              </tr>
          </tbody>
        </table>
        <div class="map" style="width:80%;height:300px"></div><br/>
        <a href="" class="btn btn-primary">Back</a>
    </script>

    <script>
    function validate(user) {
        username = user.username.trim();
        pass = user.password.trim();
        $('.username').html("");
        $('.password').html("");

        if (username === "") {
            $('.username').html('Username cannot be empty');

            if (pass === "") {
                $('.password').html('Password cannot be empty');
            }
            return false;
        }
        return true;
    }
    </script>

    <script>
        $.ajaxPrefilter( function( options, originalOptions, jqXHR ) {
            options.url = 'http://localhost:8000' + options.url;
        });
        function htmlEncode(value){
          return $('<div/>').text(value).html();
        }
        $.fn.serializeObject = function() {
          var o = {};
          var a = this.serializeArray();
          $.each(a, function() {
              if (o[this.name] !== undefined) {
                  if (!o[this.name].push) {
                      o[this.name] = [o[this.name]];
                  }
                  o[this.name].push(this.value || '');
              } else {
                  o[this.name] = this.value || '';
              }
          });
          return o;
        };

        /////////////// Models /////////////////////////
        var User = Backbone.Model.extend({
            urlRoot: '/accounts/'
        });

        var Courier = Backbone.Model.extend({
            urlRoot: '/parcels'
        });

        ////////////// Views ////////////////////////////
        var LoginView = Backbone.View.extend({
            el: '.home-page',

            events: {
                'submit .login-form': 'login'
            },

            login: function(ev) {
                ev.preventDefault();
                var that = this;
                var userDetails = $(ev.currentTarget).serializeObject();
                if(validate(userDetails)) {
                    var user = new User();
                    user.urlRoot += 'login';
                    user.save(userDetails, {
                        success: function(userDetails) {
                            window.localStorage.setItem('userDetails', userDetails);
                            that.$el.html('');
                            router.navigate('/#dashboard', true);
                        },

                        error: function(err) {
                            console.log(err);
                        }
                    });
                }
            },

            render: function() {
                $('.dashboard').html('');
                var template = _.template($('#login-page').html());
                this.$el.html(template);
            }
        });
        var loginView = new LoginView();

        var SignupView = Backbone.View.extend({
            el: '.home-page',

            render: function() {
                var template = _.template($('#signup-page').html());
                this.$el.html(template);
            }
        });
        var signupView = new SignupView();

        var CourierDetailsView = Backbone.View.extend({
            el: '.courier-details',

            loadMap: function(lat, long) {
                var mapCanvas = document.getElementsByClassName('map')[0];
                var myLatLng = {lat: parseFloat(lat), lng: parseFloat(long)};
                var mapOptions = {
                    center: myLatLng,
                    zoom: 13
                }
                var map = new google.maps.Map(mapCanvas, mapOptions);

                var marker = new google.maps.Marker({
                    position: myLatLng,
                    map: map,
                    title: "You're parcel is here!"
                });
            },

            render: function(courierId) {
                var that = this;
                var courier = new Courier({id: courierId});
                courier.fetch({
                    success: function(parcel) {
                        var template = _.template($('#courier-details').html(), {parcel: parcel});
                        that.$el.html(template);
                        that.loadMap(parcel.get('current_location_lat'), parcel.get('current_location_long'));
                    },

                    error: function(err, response) {
                        console.log(response.status);
                        if (response.status == 401)
                            that.$el.html("<h3>Not Logged In. Please Login.</h3><a href=\"/\" class=\"btn btn-primary\">Back</a>")
                        else
                            that.$el.html("<h3>Invalid Courier ID</h3><a href=\"\" class=\"btn btn-primary\">Back</a>");
                    }
                });
            }
        });
        var courierDetailsView = new CourierDetailsView();

        var DashBoardView = Backbone.View.extend({
            el: '.dashboard',

            events: {
                'click .logout': 'logout',
                'click .add-courier': 'addCourier',
                'click .update-courier': 'updateCourier',
                'click .back': 'back'
            },

            back: function(ev) {
                var template = _.template($('#dashboard-page').html());
                this.$el.html(template);
            },

            addCourier: function(ev) {
                var template = _.template($('#add-courier').html());
                this.$el.html(template);
            },

            updateCourier: function(ev) {
                var template = _.template($('#update-courier').html());
                this.$el.html(template);
            },

            logout: function(ev) {
                var that = this;
                var user = new User();
                user.urlRoot += 'logout';
                user.fetch({
                    dataType: 'text',
                    success: function(respText, response) {
                        window.localStorage.removeItem('userDetails');
                        that.$el.html('');
                        router.navigate('/', true);
                    },

                    error: function(err, response) {
                        console.log('Error in logging out');
                    }
                });
            },

            render: function() {
                if(window.localStorage.getItem('userDetails') == null)
                    router.navigate('/#login', true);
                else {
                    $('.home-page').html('');
                    var template = _.template($('#dashboard-page').html());
                    this.$el.html(template);
                }
            }
        });
        var dashboardView = new DashBoardView();

        var HomePageView = Backbone.View.extend({
            el: '.home-page',

            events: {
                'submit .track-courier-form': 'track',
                'click .logout': 'logout'
            },

            logout: function(ev) {
                if (window.localStorage.getItem('userDetails') == null)
                    alert('User is not logged in');
                else {
                    var that = this;
                    var user = new User();
                    user.urlRoot += 'logout';
                    user.fetch({
                        dataType: 'text',
                        success: function(respText, response) {
                            window.localStorage.removeItem('userDetails');
                            that.render();
                            console.log('Logout Successful');
                        },

                        error: function(err, response) {
                            console.log('Error in logging out');
                        }
                    });
                }
            },

            track: function(ev) {
                ev.preventDefault();
                var courierId = $(ev.currentTarget).serializeObject().courier;
                this.$el.html('');
                router.navigate('/courier-details/' + courierId, true);
            },

            render: function() {
                // Basically maintain some kind of global session object and check if the user is logged in.
                var template = _.template($('#home-page').html());
                this.$el.html(template);
            }
        });
        var homePageView = new HomePageView();

        /////////////// Router ///////////////////////////
        var Router = Backbone.Router.extend({
            routes: {
                "": "home",
                "login": "login",
                "signup": "signup",
                "courier-details/:id": "courier-details",
                "dashboard": "dashboard"
            }
        });
        var router = new Router;

        router.on('route:home', function() {
            homePageView.render();
        });

        router.on('route:login', function() {
            loginView.render();
        });

        router.on('route:signup', function() {
            signupView.render();
        });

        router.on('route:courier-details', function(id) {
            courierDetailsView.render(id);
        });

        router.on('route:dashboard', function() {
            dashboardView.render();
        });

        Backbone.history.start();
        // Backbone.history.start({ pushState: true });
        //
        // $(document).on("click", "a", function(e) {
        //     e.preventDefault();
        //     var href = $(e.currentTarget).attr('href');
        //     router.navigate(href, true);
        // });
    </script>
</body>
</html>
